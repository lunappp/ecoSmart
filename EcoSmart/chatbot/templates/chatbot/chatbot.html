<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoBot - Asistente Financiero</title>
    {% load static %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: slideInRight 0.3s ease-out;
        }
        .chat-message-bot {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: slideInLeft 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .typing-indicator {
            display: none;
        }
        .typing-indicator.show {
            display: flex;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg border-b border-gray-200">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">EcoBot</h1>
                        <p class="text-sm text-gray-500">Tu asistente financiero inteligente</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                    <span class="text-sm text-gray-600">En lÃ­nea</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Chat Container -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Chat Window -->
            <div id="chat-window" class="h-96 overflow-y-auto p-6 space-y-4 bg-gray-50">
                <!-- Welcome Message -->
                <div class="flex justify-start">
                    <div class="chat-message-bot max-w-xs lg:max-w-md px-4 py-3 rounded-2xl text-white shadow-lg">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-robot text-xs"></i>
                            <span class="text-xs font-semibold">EcoBot</span>
                        </div>
                        <p class="text-sm">Â¡Hola! Soy EcoBot, tu compaÃ±ero financiero. Estoy aquÃ­ para ayudarte con consejos personalizados basados en tu plan. Â¿En quÃ© puedo asistirte hoy?</p>
                        <span class="text-xs opacity-75 block mt-2">Ahora</span>
                    </div>
                </div>

                {% for message in messages %}
                <!-- User Message -->
                <div class="flex justify-end">
                    <div class="chat-message-user max-w-xs lg:max-w-md px-4 py-3 rounded-2xl text-white shadow-lg">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-user text-xs"></i>
                            <span class="text-xs font-semibold">TÃº</span>
                        </div>
                        <p class="text-sm">{{ message.user_message }}</p>
                        <span class="text-xs opacity-75 block mt-2">{{ message.timestamp|date:"H:i" }}</span>
                    </div>
                </div>

                <!-- Bot Message -->
                <div class="flex justify-start">
                    <div class="chat-message-bot max-w-xs lg:max-w-md px-4 py-3 rounded-2xl text-white shadow-lg">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-robot text-xs"></i>
                            <span class="text-xs font-semibold">EcoBot</span>
                        </div>
                        <p class="text-sm">{{ message.bot_response }}</p>
                        <span class="text-xs opacity-75 block mt-2">{{ message.timestamp|date:"H:i" }}</span>
                    </div>
                </div>
                {% endfor %}

                <!-- Typing Indicator -->
                <div class="flex justify-start">
                    <div class="typing-indicator bg-white border border-gray-200 max-w-xs px-4 py-3 rounded-2xl shadow-sm">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-robot text-gray-400 text-xs"></i>
                            <span class="text-xs text-gray-500">EcoBot estÃ¡ escribiendo</span>
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 p-4 bg-white">
                <form id="chat-form" method="post" action="{% url 'send_message' plan_id %}">
                    {% csrf_token %}
                    <div class="flex items-center space-x-3">
                        <div class="flex-1 relative">
                            <input type="text" id="message-input" name="message"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-12"
                                   placeholder="Escribe tu mensaje sobre finanzas..." required>
                            <button type="button" id="voice-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        <button type="submit" id="send-btn"
                                class="bg-gradient-to-r from-green-400 to-blue-500 text-white p-3 rounded-full hover:from-green-500 hover:to-blue-600 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>

                <!-- Quick Suggestions -->
                    <div class="flex flex-wrap gap-2 mt-3">
                        <button class="quick-suggest bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors"
                                data-message="consejo">ðŸ’¡ Consejo</button>
                        <button class="quick-suggest bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors"
                                data-message="HÃ¡blame de mi ahorro">ðŸ’° Mi ahorro</button>
                        <button class="quick-suggest bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors"
                                data-message="Ayuda con presupuesto">ðŸ“Š Presupuesto</button>
                        <button class="quick-suggest bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors"
                                data-message="Consejos de inversiÃ³n">ðŸ“ˆ Inversiones</button>
                        <button class="quick-suggest bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors"
                                data-message="Problemas financieros">ðŸ¤” Ayuda financiera</button>
                    </div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="text-center mt-6">
            <a href="{% url 'Menu_plan' plan_id %}" class="inline-flex items-center bg-gradient-to-r from-gray-600 to-gray-700 text-white px-6 py-3 rounded-full hover:from-gray-700 hover:to-gray-800 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">
                <i class="fas fa-arrow-left mr-2"></i>
                Volver al menÃº del plan
            </a>
        </div>
    </div>

    <script>
    document.getElementById('chat-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const message = document.getElementById('message-input').value.trim();
        if (!message) return;

        sendMessage(message);
    });

    // Quick suggestion buttons
    document.querySelectorAll('.quick-suggest').forEach(button => {
        button.addEventListener('click', function() {
            const message = this.getAttribute('data-message');
            sendMessage(message);
        });
    });

    function sendMessage(message) {
        const chatWindow = document.getElementById('chat-window');
        const typingIndicator = document.querySelector('.typing-indicator');

        // Add user message
        const userMessageHtml = `
            <div class="flex justify-end animate-fade-in">
                <div class="chat-message-user max-w-xs lg:max-w-md px-4 py-3 rounded-2xl text-white shadow-lg">
                    <div class="flex items-center space-x-2 mb-2">
                        <i class="fas fa-user text-xs"></i>
                        <span class="text-xs font-semibold">TÃº</span>
                    </div>
                    <p class="text-sm">${message}</p>
                    <span class="text-xs opacity-75 block mt-2">Ahora</span>
                </div>
            </div>
        `;
        chatWindow.insertAdjacentHTML('beforeend', userMessageHtml);

        // Clear input
        document.getElementById('message-input').value = '';

        // Show typing indicator
        typingIndicator.classList.add('show');
        chatWindow.scrollTop = chatWindow.scrollHeight;

        // Send to server
        fetch('{% url "send_message" plan_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: 'message=' + encodeURIComponent(message)
        })
        .then(response => response.json())
        .then(data => {
            // Hide typing indicator
            typingIndicator.classList.remove('show');

            if (data.response) {
                // Add bot response
                const botMessageHtml = `
                    <div class="flex justify-start animate-fade-in">
                        <div class="chat-message-bot max-w-xs lg:max-w-md px-4 py-3 rounded-2xl text-white shadow-lg">
                            <div class="flex items-center space-x-2 mb-2">
                                <i class="fas fa-robot text-xs"></i>
                                <span class="text-xs font-semibold">EcoBot</span>
                            </div>
                            <p class="text-sm">${data.response}</p>
                            <span class="text-xs opacity-75 block mt-2">Ahora</span>
                        </div>
                    </div>
                `;
                chatWindow.insertAdjacentHTML('beforeend', botMessageHtml);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        })
        .catch(error => {
            typingIndicator.classList.remove('show');
            console.error('Error:', error);
        });
    }

    // Enter key support
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        }
    });

    // Auto-resize input (optional enhancement)
    const input = document.getElementById('message-input');
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });
    </script>
</body>
</html>