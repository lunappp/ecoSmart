{% extends 'base_plan.html' %}
{% load static %}

{% block title %}Chatbot EcoSmart{% endblock %}

{% block extra_head %}
<style>
    :root {
        --primary: #a855f7;
        --primary-light: #c084fc;
        --primary-dark: #9333ea;
        --secondary: #8b5cf6;
        --success: #a78bfa;
        --danger: #ef4444;
        --warning: #f59e0b;
        --background: #faf5ff;
        --surface: #ffffff;
        --text: #581c87;
        --text-light: #6b7280;
        --border: #e5e7eb;
        --radius: 12px;
        --shadow: 0 4px 12px rgba(0,0,0,0.1);
        --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
        --transition: 0.3s;
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', system-ui,sans-serif;}

    @media (max-width: 768px) {
        .max-w-4xl {
            max-width: 100% !important;
            padding: 1rem !important;
        }

        .h-96 {
            height: 70vh !important;
        }

        .text-2xl {
            font-size: 1.25rem !important;
        }

        .text-xl {
            font-size: 1.125rem !important;
        }

        .p-6 {
            padding: 1rem !important;
        }
    }

    @media (max-width: 480px) {
        .max-w-4xl {
            padding: 0.5rem !important;
        }

        .h-96 {
            height: 60vh !important;
        }

        .px-6 {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }

        .py-3 {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }

        .text-sm {
            font-size: 0.75rem !important;
        }
    }
</style>
{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto px-6">
    <!-- Chat Window -->
    <div class="action-card" style="margin-bottom: 2rem;">
        <div class="action-icon">
            <i class="fas fa-comments"></i>
        </div>
        <div class="action-content" style="flex: 1;">
            <h3>Conversación con EcoSmart AI</h3>
            <p>Tu asistente financiero personalizado</p>
        </div>
    </div>

    <div id="chat-window" class="bg-white rounded-lg shadow-lg p-6 h-[500px] overflow-y-auto mb-6 border border-gray-200">
        {% for message in messages %}
        <div class="mb-4">
            <div class="flex items-start gap-3 justify-end mb-3">
                <div class="bg-blue-50 rounded-2xl rounded-tl-md px-4 py-3 max-w-xs lg:max-w-md">
                    <p class="text-gray-800 text-base">{{ message.user_message }}</p>
                </div>
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-user text-blue-600 text-sm"></i>
                </div>
            </div>
            <div class="flex items-start gap-3">
                <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl rounded-tr-md px-4 py-3 max-w-xs lg:max-w-md">
                    <div class="text-white text-base whitespace-pre-line">{{ message.bot_response }}</div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-8">
            <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-robot text-white text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">¡Hola! Soy tu asistente EcoSmart</h3>
            <p class="text-gray-600">Pregúntame sobre finanzas, consejos económicos o cualquier duda sobre tu plan.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Input Form -->
    <div class="bg-white rounded-lg shadow-lg p-6 border border-gray-200">
        <form id="chat-form" method="post" action="{% url 'send_message' plan.id %}">
            {% csrf_token %}
            <div class="flex gap-3">
                <div class="flex-1">
                    <input type="text" id="message-input" name="message"
                           class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200"
                           placeholder="Escribe tu mensaje aquí..." required>
                </div>
                <button type="submit"
                        class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-full hover:from-purple-600 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Scroll to bottom on page load
    document.addEventListener('DOMContentLoaded', function() {
        const chatWindow = document.getElementById('chat-window');
        chatWindow.scrollTop = chatWindow.scrollHeight;
    });

    document.getElementById('chat-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const message = document.getElementById('message-input').value;
        fetch('{% url "send_message" plan.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: 'message=' + encodeURIComponent(message)
        })
        .then(response => response.json())
        .then(data => {
            if (data.response) {
                const chatWindow = document.getElementById('chat-window');
                const newMessageHTML = `
                    <div class="mb-4">
                        <div class="flex items-start gap-3 justify-end mb-3">
                            <div class="bg-blue-50 rounded-2xl rounded-tl-md px-4 py-3 max-w-xs lg:max-w-md">
                                <p class="text-gray-800 text-base">${message}</p>
                            </div>
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-user text-blue-600 text-sm"></i>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-robot text-white text-sm"></i>
                            </div>
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl rounded-tr-md px-4 py-3 max-w-xs lg:max-w-md">
                                <div class="text-white text-base whitespace-pre-line">${data.response}</div>
                            </div>
                        </div>
                    </div>
                `;
                chatWindow.insertAdjacentHTML('beforeend', newMessageHTML);
                document.getElementById('message-input').value = '';
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        });
    });
</script>
{% endblock %}