 {% load static %}
 <!DOCTYPE html>
 <html lang="es">
 <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - {{ plan.nombre }}</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #a855f7;
            --primary-light: #c084fc;
            --primary-dark: #9333ea;
            --secondary: #8b5cf6;
            --success: #a78bfa;
            --danger: #ef4444;
            --warning: #f59e0b;
            --background: #faf5ff;
            --surface: #ffffff;
            --text: #581c87;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --radius: 12px;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
            --transition: 0.3s;
        }

        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', system-ui,sans-serif;}

        body{display:flex;min-height:100vh;background:var(--background);color:var(--text);}

        /* ===== SIDEBAR ===== */
        .sidebar{
          width:260px;
          background:var(--surface);
          box-shadow:var(--shadow);
          display:flex;
          flex-direction:column;
          position:fixed;
          height:100vh;
          transition:width var(--transition);
        }
        .sidebar.collapsed{width:80px;}
        .sidebar-header{display:flex;align-items:center;justify-content:space-between;padding:1rem;border-bottom:1px solid var(--border);}
        .logo{display:flex;align-items:center;gap:0.75rem;}
        .logo-icon{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;}
        .logo-text{font-size:1.4rem;font-weight:700;transition:opacity var(--transition);}
        .sidebar.collapsed .logo-text{opacity:0;pointer-events:none;}
        .toggle-btn{background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--text);}
        .menu{flex:1;padding:1rem 0;}
        .menu-item{display:flex;align-items:center;gap:1rem;padding:0.75rem 1.5rem;color:var(--text-light);text-decoration:none;transition:all var(--transition);font-weight:500;border-radius:var(--radius);}
        .menu-item:hover{background:var(--primary-light);color:white;}
        .menu-item.active{background:var(--primary);color:white;}
        .menu-item i{min-width:24px;text-align:center;}
        .sidebar.collapsed .menu-item span{display:none;}
        .sidebar-footer{padding:1rem;border-top:1px solid var(--border);text-align:center;font-size:0.85rem;color:var(--text-light);}

        /* ===== MAIN ===== */
        main{flex:1;margin-left:260px;padding:2rem;transition:margin-left var(--transition);}
        .sidebar.collapsed + main{margin-left:80px;}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;}
        .header h1{font-size:1.8rem;color:var(--text);}
        .user-info{display:flex;align-items:center;gap:1rem;}
        .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:600;}
        .btn-logout{padding:0.4rem 0.8rem;background:var(--primary);color:white;border:none;border-radius:var(--radius);cursor:pointer;transition:var(--transition);}
        .btn-logout:hover{opacity:0.85;}

        /* ===== RESPONSIVE ===== */
        @media(max-width:768px){
          .sidebar{position:fixed;z-index:1000;transform:translateX(-100%);}
          .sidebar.active{transform:translateX(0);}
          main{margin-left:0;padding:1rem;}
        }
    </style>
 </head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">E</div>
        <span class="logo-text">EcoSmart</span>
      </div>
      <button class="toggle-btn" id="toggle-btn">‚ò∞</button>
    </div>
    <nav class="menu">
      <a href="#" class="menu-item active" data-view="estadisticas" onclick="loadView('estadisticas', {{ plan.id }})"><i>üìä</i><span>Estad√≠sticas</span></a>
      <a href="#" class="menu-item" data-view="ingresos" onclick="loadView('ingresos', {{ plan.id }})"><i>üí∞</i><span>Ingresos</span></a>
      <a href="#" class="menu-item" data-view="gastos" onclick="loadView('gastos', {{ plan.id }})"><i>üí∏</i><span>Gastos</span></a>
      <a href="#" class="menu-item" data-view="objetivos" onclick="loadView('objetivos', {{ plan.id }})"><i>üéØ</i><span>Objetivos</span></a>
      <a href="#" class="menu-item" data-view="tareas" onclick="loadView('tareas', {{ plan.id }})"><i>üìù</i><span>Tareas</span></a>
      <a href="#" class="menu-item" data-view="historiales" onclick="loadView('historiales', {{ plan.id }})"><i>üìà</i><span>Historiales</span></a>
      <a href="{% url 'chatbot_redirect' plan.id %}" class="menu-item"><i>ü§ñ</i><span>Chatbot IA</span></a>
      {% if plan.tipo_plan == 'grupal' %}
      <a href="#" class="menu-item" data-view="ajustes" onclick="loadView('ajustes', {{ plan.id }})"><i>üë•</i><span>Miembros</span></a>
      {% endif %}
      <a href="{% url 'Dashboard' %}" class="menu-item"><i>üè†</i><span>Dashboard</span></a>
    </nav>
    <div class="sidebar-footer">¬© 2025 EcoSmart</div>
  </aside>

  <!-- Main -->
  <main>
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <div class="flex justify-between items-center mb-6 border-b pb-2">
            <h1 class="text-3xl font-extrabold text-gray-900">
                üìä Estad√≠sticas del Plan: {{ plan.nombre }}
            </h1>
            <a href="{% url 'historiales' plan_id=plan.id %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150">
                Ver Historiales Completos
            </a>
        </div>
    
        <!-- Resumen Financiero -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Saldo Total -->
            <div class="bg-gradient-to-r from-indigo-50 to-indigo-100 p-6 rounded-xl shadow-lg border border-indigo-200 hover:shadow-xl transition-shadow">
                <div class="flex items-center mb-2">
                    <svg class="w-8 h-8 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                    <p class="text-sm font-medium text-indigo-700">Saldo Actual</p>
                </div>
                <p class="text-4xl font-extrabold text-indigo-900">${{ dinero_info.total_dinero|floatformat:2 }}</p>
            </div>
            <!-- Total Ingresos -->
            <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-xl shadow-lg border border-green-200 hover:shadow-xl transition-shadow">
                <div class="flex items-center mb-2">
                    <svg class="w-8 h-8 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                    <p class="text-sm font-medium text-green-700">Total Ingresos</p>
                </div>
                <p class="text-4xl font-extrabold text-green-900">${{ dinero_info.ingreso_total|floatformat:2 }}</p>
            </div>
            <!-- Total Gastos -->
            <div class="bg-gradient-to-r from-red-50 to-red-100 p-6 rounded-xl shadow-lg border border-red-200 hover:shadow-xl transition-shadow">
                <div class="flex items-center mb-2">
                    <svg class="w-8 h-8 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                    </svg>
                    <p class="text-sm font-medium text-red-700">Total Gastos</p>
                </div>
                <p class="text-4xl font-extrabold text-red-900">${{ dinero_info.gasto_total|floatformat:2 }}</p>
            </div>
        </div>
        
        <!-- Gr√°ficos y Desglose por Categor√≠a -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Desglose de Ingresos por Tipo -->
            <div class="bg-white p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 text-green-700 border-b pb-2">üìà Desglose de Ingresos por Tipo</h2>

                {% if ingresos_por_tipo %}
                <div class="mb-4">
                    <canvas id="ingresosTipoChart" width="400" height="200"></canvas>
                </div>
                <ul class="space-y-3">
                    {% for item in ingresos_por_tipo %}
                    <li class="flex justify-between items-center p-3 rounded-lg bg-green-50">
                        <span class="font-semibold text-gray-800">{{ item.tipo_ingreso }}</span>
                        <span class="text-lg font-bold text-green-600">${{ item.total|floatformat:2 }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                    <p class="text-gray-500 p-8 bg-gray-50 rounded-lg text-center">No hay ingresos para analizar categor√≠as.</p>
                {% endif %}
            </div>

            <!-- Desglose de Gastos por Tipo -->
            <div class="bg-white p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 text-red-700 border-b pb-2">üìâ Desglose de Gastos por Tipo</h2>

                {% if gastos_por_tipo %}
                <div class="mb-4">
                    <canvas id="gastosTipoChart" width="400" height="200"></canvas>
                </div>
                <ul class="space-y-3">
                    {% for item in gastos_por_tipo %}
                    <li class="flex justify-between items-center p-3 rounded-lg bg-red-50">
                        <span class="font-semibold text-gray-800">{{ item.tipo_gasto }}</span>
                        <span class="text-lg font-bold text-red-600">${{ item.total|floatformat:2 }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                    <p class="text-gray-500 p-8 bg-gray-50 rounded-lg text-center">No hay gastos para analizar categor√≠as.</p>
                {% endif %}
            </div>

        </div>

        <!-- Desglose por Miembro -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">

            <!-- Desglose de Ingresos por Miembro -->
            <div class="bg-white p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 text-blue-700 border-b pb-2">Desglose de Ingresos por Miembro</h2>

                {% if ingresos_por_usuario %}
                <ul class="space-y-3">
                    {% for item in ingresos_por_usuario %}
                    <li class="flex justify-between items-center p-3 rounded-lg bg-blue-50">
                        <span class="font-semibold text-gray-800">{{ item.user__username|default:"Usuario Desconocido" }}</span>
                        <span class="text-lg font-bold text-blue-600">${{ item.total|floatformat:2 }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                    <p class="text-gray-500 p-8 bg-gray-50 rounded-lg text-center">No hay ingresos registrados por miembros.</p>
                {% endif %}
            </div>

            <!-- Desglose de Gastos por Miembro -->
            <div class="bg-white p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 text-orange-700 border-b pb-2">Desglose de Gastos por Miembro</h2>

                {% if gastos_por_usuario %}
                <ul class="space-y-3">
                    {% for item in gastos_por_usuario %}
                    <li class="flex justify-between items-center p-3 rounded-lg bg-orange-50">
                        <span class="font-semibold text-gray-800">{{ item.user__username|default:"Usuario Desconocido" }}</span>
                        <span class="text-lg font-bold text-orange-600">${{ item.total|floatformat:2 }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                    <p class="text-gray-500 p-8 bg-gray-50 rounded-lg text-center">No hay gastos registrados por miembros.</p>
                {% endif %}
            </div>

        </div>

        <!-- Conversor de Monedas -->
        <div class="mt-8 bg-white p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-purple-700 border-b pb-2">üí± Conversor de Monedas</h2>
            <p class="text-gray-600 mb-4">Convierte tus pesos argentinos a otras monedas del mundo.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Monto en Pesos Argentinos (ARS)</label>
                    <input type="number" id="amount" placeholder="Ingresa el monto" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" min="0" step="0.01">
                </div>
                <div>
                    <label for="currency" class="block text-sm font-medium text-gray-700 mb-2">Moneda Destino</label>
                    <select id="currency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="USD">D√≥lar Estadounidense (USD)</option>
                        <option value="EUR">Euro (EUR)</option>
                        <option value="GBP">Libra Esterlina (GBP)</option>
                        <option value="JPY">Yen Japon√©s (JPY)</option>
                        <option value="CAD">D√≥lar Canadiense (CAD)</option>
                        <option value="AUD">D√≥lar Australiano (AUD)</option>
                        <option value="CHF">Franco Suizo (CHF)</option>
                        <option value="CNY">Yuan Chino (CNY)</option>
                        <option value="BRL">Real Brasile√±o (BRL)</option>
                        <option value="MXN">Peso Mexicano (MXN)</option>
                    </select>
                </div>
            </div>

            <button id="convertBtn" class="mt-4 w-full bg-purple-600 text-white py-3 px-4 rounded-xl font-semibold hover:bg-purple-700 transition duration-150 shadow-lg">
                Convertir
            </button>

            <div id="result" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                <p id="resultText" class="text-lg font-semibold text-gray-800"></p>
            </div>
        </div>


    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Toggle sidebar
      const toggleBtn = document.getElementById('toggle-btn');
      const sidebar = document.getElementById('sidebar');
      const main = document.querySelector('main');

      toggleBtn.addEventListener('click', function() {
        sidebar.classList.toggle('collapsed');
        main.classList.toggle('sidebar-collapsed');
      });

      // Menu item active state
      const menuItems = document.querySelectorAll('.menu-item');
      const currentPath = window.location.pathname;

      menuItems.forEach(item => {
        const href = item.getAttribute('href');
        if (href && (currentPath === href || (href !== '#' && currentPath.startsWith(href)))) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    });

    function loadView(view, planId) {
      fetch(`/planes/${planId}/${view}/`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.text())
      .then(html => {
        document.querySelector('main').innerHTML = html;
        // update active menu
        document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`[data-view="${view}"]`).classList.add('active');
        // execute scripts
        const scripts = document.querySelector('main').querySelectorAll('script');
        scripts.forEach(script => {
          if (script.textContent) {
            eval(script.textContent);
          }
        });
      });
    }
    </script>

    <script>
        // Datos para gr√°ficos
        const ingresosTipoData = {
            labels: [{% for item in ingresos_por_tipo %}'{{ item.tipo_ingreso }}',{% endfor %}],
            datasets: [{
                label: 'Ingresos por Tipo',
                data: [{% for item in ingresos_por_tipo %}{{ item.total }},{% endfor %}],
                backgroundColor: [
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(168, 85, 247, 0.8)',
                    'rgba(251, 191, 36, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                ],
                borderColor: [
                    'rgba(34, 197, 94, 1)',
                    'rgba(59, 130, 246, 1)',
                    'rgba(168, 85, 247, 1)',
                    'rgba(251, 191, 36, 1)',
                    'rgba(239, 68, 68, 1)',
                ],
                borderWidth: 1
            }]
        };

        const gastosTipoData = {
            labels: [{% for item in gastos_por_tipo %}'{{ item.tipo_gasto }}',{% endfor %}],
            datasets: [{
                label: 'Gastos por Tipo',
                data: [{% for item in gastos_por_tipo %}{{ item.total }},{% endfor %}],
                backgroundColor: [
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(251, 191, 36, 0.8)',
                    'rgba(168, 85, 247, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                ],
                borderColor: [
                    'rgba(239, 68, 68, 1)',
                    'rgba(251, 191, 36, 1)',
                    'rgba(168, 85, 247, 1)',
                    'rgba(59, 130, 246, 1)',
                    'rgba(34, 197, 94, 1)',
                ],
                borderWidth: 1
            }]
        };

        // Configuraci√≥n de gr√°ficos
        const configIngresos = {
            type: 'pie',
            data: ingresosTipoData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': $' + context.parsed.toFixed(2);
                            }
                        }
                    }
                }
            }
        };

        const configGastos = {
            type: 'pie',
            data: gastosTipoData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': $' + context.parsed.toFixed(2);
                            }
                        }
                    }
                }
            }
        };

        // Crear gr√°ficos
        {% if ingresos_por_tipo %}
        new Chart(document.getElementById('ingresosTipoChart'), configIngresos);
        {% endif %}

        {% if gastos_por_tipo %}
        new Chart(document.getElementById('gastosTipoChart'), configGastos);
        {% endif %}

        // Conversor de Monedas
        document.getElementById('convertBtn').addEventListener('click', async function() {
            const amount = parseFloat(document.getElementById('amount').value);
            const currency = document.getElementById('currency').value;
            const resultDiv = document.getElementById('result');
            const resultText = document.getElementById('resultText');

            if (!amount || amount <= 0) {
                resultText.textContent = 'Por favor, ingresa un monto v√°lido.';
                resultDiv.classList.remove('hidden');
                resultDiv.classList.add('bg-red-50', 'border', 'border-red-200');
                resultDiv.classList.remove('bg-gray-50');
                return;
            }

            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/ARS');
                const data = await response.json();
                const rate = data.rates[currency];

                if (rate) {
                    const converted = amount * rate;
                    resultText.textContent = `${amount.toFixed(2)} ARS = ${converted.toFixed(2)} ${currency}`;
                    resultDiv.classList.remove('hidden');
                    resultDiv.classList.add('bg-green-50', 'border', 'border-green-200');
                    resultDiv.classList.remove('bg-red-50', 'border-red-200', 'bg-gray-50');
                } else {
                    resultText.textContent = 'Error al obtener la tasa de cambio.';
                    resultDiv.classList.remove('hidden');
                    resultDiv.classList.add('bg-red-50', 'border', 'border-red-200');
                    resultDiv.classList.remove('bg-gray-50');
                }
            } catch (error) {
                resultText.textContent = 'Error de conexi√≥n. Int√©ntalo de nuevo.';
                resultDiv.classList.remove('hidden');
                resultDiv.classList.add('bg-red-50', 'border', 'border-red-200');
                resultDiv.classList.remove('bg-gray-50');
            }
        });

    </script>



</body>
</html>