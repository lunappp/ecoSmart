<div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">
        游늶 Historiales del Plan: {{ plan.nombre }}
    </h1>


    <!-- Tabs -->
    <div class="bg-white p-6 rounded-xl shadow-2xl">
        <div class="tabs">
            <button class="tab-button" onclick="openTab('ingresos', this)">Ingresos</button>
            <button class="tab-button" onclick="openTab('gastos', this)">Gastos</button>
            <button class="tab-button active" onclick="openTab('grafico', this)">Gr치fico</button>
        </div>

        <!-- Tab Content -->
        <div id="ingresos" class="tab-content">
            {% if ingresos_list %}
            <div class="mb-4 text-center">
                <a href="{% url 'descargar_pdf_historial' plan_id=plan.id tipo='ingresos' %}"
                   class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Descargar PDF de Ingresos
                </a>
            </div>
            <ul class="space-y-4">
                {% for ingreso in ingresos_list %}
                <li class="bg-white p-4 rounded-xl shadow-lg flex justify-between items-center transition duration-150 hover:shadow-xl border-l-4 border-green-500">
                    <div class="flex items-center space-x-4">
                        {% if ingreso.imagen %}
                            <img src="{{ ingreso.imagen.url }}" alt="Imagen de {{ ingreso.nombre }}" style="width: 60px; height: 60px; object-fit: cover;" class="rounded-lg">
                        {% endif %}
                        <div>
                            <p class="text-lg font-semibold text-gray-900">{{ ingreso.nombre }}</p>
                            <p class="text-xs text-gray-500">{{ ingreso.descripcion|default:"Sin descripci칩n" }}</p>
                            <p class="text-xs font-medium text-green-600 mt-1">Tipo: {{ ingreso.get_tipo_ingreso_display }} - Usuario: {{ ingreso.user.username|default:"Usuario Desconocido" }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-extrabold text-green-600">+ ${{ ingreso.cantidad|floatformat:2 }}</p>
                        <p class="text-xs text-gray-400 mt-1">Guardado: {{ ingreso.fecha_guardado|date:"d/m/Y H:i" }}</p>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
                <p class="text-gray-500 p-8 bg-gray-50 rounded-lg text-center">No hay ingresos registrados.</p>
            {% endif %}
        </div>

        <div id="gastos" class="tab-content">
            {% if gastos_list %}
            <div class="mb-4 text-center">
                <a href="{% url 'descargar_pdf_historial' plan_id=plan.id tipo='gastos' %}"
                   class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Descargar PDF de Gastos
                </a>
            </div>
            <ul class="space-y-4">
                {% for gasto in gastos_list %}
                <li class="bg-white p-4 rounded-xl shadow-lg flex justify-between items-center transition duration-150 hover:shadow-xl border-l-4 border-red-500">
                    <div class="flex items-center space-x-4">
                        {% if gasto.imagen %}
                            <img src="{{ gasto.imagen.url }}" alt="Imagen de {{ gasto.nombre }}" style="width: 60px; height: 60px; object-fit: cover;" class="rounded-lg">
                        {% endif %}
                        <div>
                            <p class="text-lg font-semibold text-gray-900">{{ gasto.nombre }}</p>
                            <p class="text-xs text-gray-500">{{ gasto.descripcion|default:"Sin descripci칩n" }}</p>
                            <p class="text-xs font-medium text-red-600 mt-1">Tipo: {{ gasto.get_tipo_gasto_display }} - Usuario: {{ gasto.user.username|default:"Usuario Desconocido" }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-extrabold text-red-600">- ${{ gasto.cantidad|floatformat:2 }}</p>
                        <p class="text-xs text-gray-400 mt-1">Guardado: {{ gasto.fecha_guardado|date:"d/m/Y H:i" }}</p>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
                <p class="text-gray-500 p-8 bg-gray-50 rounded-lg text-center">No hay gastos registrados.</p>
            {% endif %}
        </div>

        <div id="grafico" class="tab-content active">
            <!-- Selectores de a침o y mes -->
            <div class="mb-6 flex space-x-4">
                <div class="flex-1">
                    <label for="yearSelector" class="block text-sm font-medium text-gray-700 mb-2">Seleccionar A침o:</label>
                    <select id="yearSelector" onchange="changeYear(this.value)" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        {% for anio in anios_disponibles %}
                            <option value="{{ anio }}" {% if selected_year == anio %}selected{% endif %}>
                                {{ anio }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex-1">
                    <label for="monthSelector" class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Mes:</label>
                    <select id="monthSelector" onchange="changeMonth(this.value)" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">{% now "M Y" %}</option>
                        {% for mes in meses_disponibles %}
                            {% if mes != hoy_str %}
                            <option value="{{ mes }}" {% if selected_month == mes %}selected{% endif %}>
                                {{ mes|date:"M Y" }}
                            </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            
            </div>
            
            <script>
                // Funci칩n para cambiar tabs
                function openTab(tabName, button) {
                    // Ocultar todos los contenidos de tabs
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => content.classList.remove('active'));
            
                    // Remover clase active de todos los botones
                    const tabButtons = document.querySelectorAll('.tab-button');
                    tabButtons.forEach(btn => btn.classList.remove('active'));
            
                    // Mostrar el contenido seleccionado
                    document.getElementById(tabName).classList.add('active');
            
                    // Activar el bot칩n seleccionado
                    button.classList.add('active');
            
                    // Renderizar gr치fico si es la pesta침a de gr치fico
                    if (tabName === 'grafico') {
                        renderChart();
                    }
                }
            
                // Funci칩n para cambiar de a침o
                function changeYear(yearValue) {
                    const url = new URL(window.location);
                    url.searchParams.set('year', yearValue);
                    url.searchParams.delete('month'); // Reset month when changing year
                    window.location.href = url.toString();
                }
            
                // Funci칩n para cambiar de mes
                function changeMonth(monthValue) {
                    const url = new URL(window.location);
                    if (monthValue) {
                        url.searchParams.set('month', monthValue);
                    } else {
                        url.searchParams.delete('month');
                    }
                    window.location.href = url.toString();
                }
            
                // Funci칩n para renderizar los gr치ficos
                function renderChart() {
                    // Gr치fico diario (solo si hay datos)
                    const dailyLabels = JSON.parse('{{ daily_labels_json|escapejs }}');
                    if (dailyLabels.length > 0) {
                        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
                        const dailyData = JSON.parse('{{ daily_data_json|escapejs }}');
            
                        new Chart(dailyCtx, {
                            type: 'line',
                            data: {
                                labels: dailyLabels,
                                datasets: [{
                                    label: 'Balance Diario ($)',
                                    data: dailyData,
                                    borderColor: 'rgb(54, 162, 235)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    tension: 0.1,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    }
                                },
                                scales: {
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'D칤a del Mes'
                                        }
                                    },
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
            
                    // Gr치fico mensual
                    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
                    const monthlyLabels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    const monthlyData = JSON.parse('{{ monthly_data_json|escapejs }}');
            
                    new Chart(monthlyCtx, {
                        type: 'bar',
                        data: {
                            labels: monthlyLabels,
                            datasets: [{
                                label: 'Dinero Ganado/Perdido ($)',
                                data: monthlyData,
                                backgroundColor: monthlyData.map(value => value >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'),
                                borderColor: monthlyData.map(value => value >= 0 ? 'rgb(75, 192, 192)' : 'rgb(255, 99, 132)'),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            
            
                // Renderizar gr치ficos al cargar la p치gina si la pesta침a de gr치ficos est치 activa
                if (document.getElementById('grafico') && document.getElementById('grafico').classList.contains('active')) {
                    renderChart();
                }
            </script>
            
            <style>
                .tabs {
                    display: flex;
                    border-bottom: 1px solid #e0e0e0;
                    margin-bottom: 1rem;
                }
                .tab-button {
                    background: none;
                    border: none;
                    padding: 0.75rem 1.5rem;
                    cursor: pointer;
                    font-weight: 600;
                    color: #6b7280;
                    border-bottom: 2px solid transparent;
                    transition: all 0.3s ease;
                }
                .tab-button.active {
                    color: #1f2937;
                    border-bottom-color: #3b82f6;
                }
                .tab-button:hover {
                    color: #1f2937;
                }
                .tab-content {
                    display: none;
                }
                .tab-content.active {
                    display: block;
                }
            </style>
            <div class="space-y-8">
                <div class="bg-gray-50 p-6 rounded-lg">
                    {% if daily_labels_json|length > 2 %}
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">
                            {% if selected_month %}
                                Resumen de {{ selected_month|date:"M Y" }}
                            {% else %}
                                Resumen de {{ current_month }}
                            {% endif %}
                        </h3>
                        <canvas id="dailyChart" width="400" height="200"></canvas>
                    {% else %}
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">
                            {% if selected_month %}
                                Resumen de {{ selected_month|date:"M Y" }}
                            {% else %}
                                Resumen de {{ current_month }}
                            {% endif %}
                        </h3>
                        <p class="text-gray-500 text-center py-8">No hay datos de este mes</p>
                    {% endif %}
                </div>
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Resumen de {{ current_year }}</h3>
                    <canvas id="monthlyChart" width="400" height="200"></canvas>
                </div>
                <div class="text-center mt-6">
                    <a href="{% url 'descargar_pdf_graficos' plan_id=plan.id %}?{% if selected_year %}year={{ selected_year }}{% endif %}{% if selected_month %}&month={{ selected_month }}{% endif %}"
                       class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Descargar PDF
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>